---
- name: Preparar nodos base para OpenStack (entorno mixto)
  hosts: all
  become: true

  vars:
    base_packages:
      - python3
      - python3-pip
      - python3-venv
      - curl
      - vim
      - git
      - chrony
      - ca-certificates
      - apt-transport-https

    docker_packages:
      - docker.io

    ntp_server: "50.50.1.15"  # deploy01

  tasks:

    - name: Validar sistema operativo soportado
      ansible.builtin.assert:
        that:
          - ansible_distribution == "Ubuntu"
          - ansible_distribution_version is version('22.04', '>=')
        fail_msg: "Este playbook solo soporta Ubuntu 22.04+"

    - name: Actualizar índice de paquetes
      apt:
        update_cache: yes

    - name: Instalar paquetes base
      apt:
        name: "{{ base_packages }}"
        state: present

    - name: Instalar Docker SDK para Python (pip)
      pip:
        name: docker
        executable: pip3

    - name: Instalar Docker
      apt:
        name: "{{ docker_packages }}"
        state: present

    - name: Habilitar y arrancar Docker
      service:
        name: docker
        state: started
        enabled: true

    - name: Habilitar Chrony
      service:
        name: chrony
        state: started
        enabled: true

    - name: Desactivar swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    - name: Asegurar que swap no se reactive
      replace:
        path: /etc/fstab
        regexp: '(^.*swap.*$)'
        replace: '# \1'

    - name: Ajustes de kernel para nodos compute
      when: "'compute' in group_names"
      block:
        - name: Cargar módulos necesarios
          modprobe:
            name: br_netfilter
            state: present

        - name: Habilitar sysctl para networking
          sysctl:
            name: "{{ item.key }}"
            value: "{{ item.value }}"
            state: present
            reload: yes
          loop:
            - { key: net.bridge.bridge-nf-call-iptables, value: 1 }
            - { key: net.ipv4.ip_forward, value: 1 }

    - name: Preparación básica de storage nodes
      when: "'storage' in group_names"
      block:
        - name: Instalar utilidades de disco
          apt:
            name:
              - lvm2
              - xfsprogs
            state: present

    - name: Configurar zona horaria y sincronización NTP (Colombia)
      block:

        - name: Establecer zona horaria a America/Bogota
          ansible.builtin.command: timedatectl set-timezone America/Bogota

# -------------------------------
# Configuración NTP según rol
# -------------------------------

        - name: Configurar ctrl01 como servidor NTP
          block:
            - name: Asegurar que chrony esté instalado
              apt:
                name: chrony
                state: present

            - name: Configurar ctrl01 para permitir clientes de la red
              blockinfile:
                path: /etc/chrony/chrony.conf
                block: |
                  allow 50.50.1.0/24
                  local stratum 10

            - name: Reiniciar chrony en ctrl01
              service:
                name: chrony
                state: restarted
                enabled: true
          when: inventory_hostname == "ctrl01"

        - name: Configurar nodos clientes para apuntar a ctrl01
          block:
            - name: Asegurar que chrony esté instalado
              apt:
                name: chrony
                state: present

            - name: Apuntar chrony al servidor ctrl01
              lineinfile:
                path: /etc/chrony/chrony.conf
                regexp: '^server'
                line: "server {{ ntp_server }} iburst"
                create: yes

            - name: Reiniciar chrony en clientes
              service:
                name: chrony
                state: restarted
                enabled: true
          when: inventory_hostname != "ctrl01"

        - name: Forzar sincronización inicial del reloj con Chrony
          ansible.builtin.command: chronyc -a makestep

        - name: Verificar sincronización del reloj
          ansible.builtin.command: timedatectl status
          register: timedatectl_status
          changed_when: false

        - name: Mostrar estado de la hora del sistema
          ansible.builtin.debug:
            msg: "{{ timedatectl_status.stdout_lines }}"

# ------------------------------------------------------
# Configuración Open vSwitch y irqbalance Nodos Compute
# ------------------------------------------------------

    - name: Preparar Open vSwitch en nodos compute
      when: "'compute' in group_names"
      become: true
      block:

        - name: Actualizar cache APT (una sola vez)
          apt:
            update_cache: yes
            cache_valid_time: 3600

        - name: Instalar Open vSwitch
          apt:
            name: openvswitch-switch
            state: present

        - name: Detener Open vSwitch si está activo
          service:
            name: openvswitch-switch
            state: stopped
          ignore_errors: true

        - name: Verificar si existe la DB de Open vSwitch
          stat:
            path: /etc/openvswitch/conf.db
          register: ovsdb_stat

        - name: Eliminar lock huérfano de OVS (si existe)
          file:
            path: /etc/openvswitch/.conf.db.~lock~
            state: absent
          when: not ovsdb_stat.stat.exists

        - name: Inicializar DB de Open vSwitch (solo si no existe)
          command: ovsdb-tool create /etc/openvswitch/conf.db /usr/share/openvswitch/vswitch.ovsschema
          when: not ovsdb_stat.stat.exists

        # Directorios runtime requeridos por ovsdb-server
        - name: Asegurar directorios runtime de Open vSwitch
          file:
            path: "{{ item }}"
            state: directory
            owner: root
            group: root
            mode: '0755'
          loop:
            - /run/openvswitch
            - /var/run/openvswitch

        - name: Iniciar Open vSwitch con systemd
          service:
            name: openvswitch-switch
            state: started
            enabled: true

        - name: Verificar que OVS esté operativo
          command: ovs-vsctl show
          register: ovs_status
          changed_when: false

        - name: Mostrar estado de Open vSwitch
          debug:
            msg: "{{ ovs_status.stdout_lines }}"

    - name: Instalar y habilitar irqbalance en nodos compute
      when: "'compute' in group_names"
      become: true
      block:

        - name: Instalar irqbalance
          apt:
            name: irqbalance
            state: present

        - name: Habilitar y arrancar irqbalance
          service:
            name: irqbalance
            state: started
            enabled: true